\chapter{Programació}
\section{Funcionament}
L'aplicació a l'arrancar es posa en contacte amb els nodes que coneix. Per cada node s'intercanvien la informació necessària per tal de poder-se identificar i enrutar els paquets.
\section{Disseny del Protocol}
\subsection{Seguretat}
L'objectiu es que tots els nodes puguin realitzar els túnels amb les garanties de les operacions criptogràfiques com el xifrat, la firma digital i el no repudi. De manera que cada node té les garanties de estar entregant l'informació directament al destí correcte i sap que cap altre pot estar ni llegint ni manipulant.

Per assolir aquest objectiu s'han de realitzar connexions directes entre tots els nodes, i no es pot realitzar agregacions de nodes com típicament es fa en xarxes \keyword{P2P}{Peer to peer} mitjançant nodes \emph{relay}. També es necessari un mecanisme de validació de les rutes que cada node ofereix, de manera que cap node no pugui tenir una direcció IP que pertanyi a un altre node. Aquesta última necessitat obliga a fixar un adreçament IP estàtic.

Per tant el primer que cal establir es el funcionament del adreçament IP, per a fer-ho es contemplen dos possibilitats:
\begin{itemize}
\item L'utilització de un adreçament que depengui dels identificadors dels certificats
\item L'incrustació de l'adreçament dins dels camps dels certificats
\end{itemize}
La primera opció consisteix en definir una distribució de direccions IP en la que a partir de un certificat se li pugui assignar una única IP.

\subsubsection{DTLS}

\subsection{Definició de paquets}
Per el disseny del protocol es necessita un identificador únic per cada node. Es va pensar i valorar per a aquesta aplicació les següents opcions:
\begin{itemize}
\item La IP i port del node
\item La IP publica i port del node
\item Dupleta IP local i publica
\item Xarxes que publicita el node
\end{itemize}
L'utilització de la IP i el port no és informació suficient degut a l'existència de xarxes privades i publiques, també els NAT simètrics no donen el mateix port per a tots els hosts remots on es connecti un mateix node.
L'utilització de la IP publica per aquesta tasca no és valida ja que deixa de ser única si hi ha dos nodes al costat privat abans de un NAT. Aquest dos en trobar-se es pensaran que són nodes diferents dels que coneixen amb IP pública.

\begin{table}[htb]
\begin{center}
\scriptsize
\begin{tabular}{|c|p{0.0625\linewidth}|p{0.0625\linewidth}|p{0.12\linewidth}|p{0.045\linewidth}|p{0.21875\linewidth}c|}
\hline
bits & \centering 0-3 & \centering 4-7 & \centering 8-15 & \centering 16-18 & \centering 19-31 & \\ \hline \hline
0 & \centering Version & \centering HLen & \centering ToS & \multicolumn{2}{|c}{Total Lenght} & \\ \hline
32 & \multicolumn{3}{|c|}{Identification} & \centering Flags & \centering Fragment Offset & \\ \hline
64 & \multicolumn{2}{|c|}{TTL} & \centering Protocol & \multicolumn{2}{|c}{Header Checksum} & \\ \hline
96 & \multicolumn{5}{|c}{Source Address} & \\ \hline
128 & \multicolumn{5}{|c}{Destination Address} & \\ \hline
160 & \multicolumn{5}{|c}{\em Options (Optional)} & \\ \hline
=0 & \multicolumn{5}{|c}{Data} & \\
+32 & \multicolumn{5}{|c}{\ldots} & \\ \hline
\end{tabular}
\end{center}
\begin{center}
\caption{Packet IPv4}
\label{T:ippkt}
\end{center}
\end{table}

\begin{table}[htb]
\begin{center}
\scriptsize
\begin{tabular}{|c|p{0.0625\linewidth}|p{0.0625\linewidth}|p{0.125\linewidth}|p{0.25\linewidth}c|}
\hline
bits & \centering 0-3 & \centering 4-7 & \centering 8-15 & \centering 16-31 & \\ \hline \hline
0 & \centering 0000 & \centering 0001 & \centering Pkt ID & \centering Total Lenght & \\ \hline
\end{tabular}
\end{center}
\begin{center}
\caption{Capçalera Packet Intern}
\label{T:inpkt}
\end{center}
\end{table}

\begin{table}[htb]
\begin{center}
\scriptsize
\begin{tabular}{|c|p{0.0625\linewidth}|p{0.0625\linewidth}|p{0.125\linewidth}|p{0.25\linewidth}c|}
\hline
bits & \centering 0-3 & \centering 4-7 & \centering 8-15 & \centering 16-31 & \\ \hline \hline
0 & \centering 0000 & \centering 0001 & \centering 0x00 & \centering Total Lenght & \\ \hline
32 & \multicolumn{2}{|c|}{\# Networks} & \centering \# IP-Ports & \\ \cline{0-3} \noalign{\vskip 2pt} \hline
48 & \multicolumn{4}{|c}{Network IP} & \\ \hline
80 & \multicolumn{4}{|c}{Network Netmask} & \\ \hline
112 & \multicolumn{4}{|c}{\ldots} & \\ \hline
144 & \multicolumn{4}{|c}{\ldots} & \\ \cline{0-5} \noalign{\vskip 2pt} \cline{0-5}
=0 & \multicolumn{4}{|c}{Host IP} & \\ \hline
+32 & \multicolumn{3}{|c|}{UDP Port} & \\ \hline
+48 & \multicolumn{4}{|c}{\ldots} & \\ \hline
+80 & \multicolumn{3}{|c|}{\ldots} & \\ \cline{0-3}
\end{tabular}
\end{center}
\begin{center}
\caption{Packet ID}
\label{T:pktid}
\end{center}
\end{table}

\begin{table}[htb]
\begin{center}
\scriptsize
\begin{tabular}{|c|p{0.0625\linewidth}|p{0.0625\linewidth}|p{0.125\linewidth}|p{0.25\linewidth}c|}
\hline
bits & \centering 0-3 & \centering 4-7 & \centering 8-15 & \centering 16-31 & \\ \hline \hline
0 & \centering 0000 & \centering 0001 & \centering 0x01 & \centering 0x04 & \\ \hline
\end{tabular}
\end{center}
\begin{center}
\caption{Packet ID ACK}
\label{T:pktidack}
\end{center}
\end{table}

\begin{table}[htb]
\begin{center}
\scriptsize
\begin{tabular}{|c|p{0.0625\linewidth}|p{0.0625\linewidth}|p{0.125\linewidth}|p{0.25\linewidth}c|}
\hline
bits & \centering 0-3 & \centering 4-7 & \centering 8-15 & \centering 16-31 & \\ \hline \hline
0 & \centering 0000 & \centering 0001 & \centering 0x02 & \centering Total Lenght & \\ \hline
32 & \multicolumn{2}{|c|}{\# Peers} \\ \cline{0-2} \noalign{\vskip 2pt} \cline{0-3}
40 & \multicolumn{2}{|c|}{\# Networks} & \centering \# IP-Ports & \\ \hline
56 & \multicolumn{4}{|c}{Network IP} & \\ \hline
88 & \multicolumn{4}{|c}{Network Netmask} & \\ \hline
120 & \multicolumn{4}{|c}{\ldots} & \\ \hline
152 & \multicolumn{4}{|c}{\ldots} & \\ \hline
=0 & \multicolumn{4}{|c}{Host IP} & \\ \hline
+32 & \multicolumn{3}{|c|}{UDP Port} & \\ \hline
+48 & \multicolumn{4}{|c}{\ldots} & \\ \hline
+80 & \multicolumn{3}{|c|}{\ldots} & \\ \cline{0-3} \noalign{\vskip 2pt} \cline{0-3}
=0 & \multicolumn{2}{|c|}{\ldots} & \centering \ldots & \\ \hline
+16 & \multicolumn{4}{|c}{\ldots} & \\ \hline
+48 & \multicolumn{4}{|c}{\ldots} & \\ \hline
=0 & \multicolumn{4}{|c}{\ldots} & \\ \hline
+32 & \multicolumn{3}{|c|}{\ldots} & \\ \cline{0-3}
\end{tabular}
\end{center}
\begin{center}
\caption{Packet KA}
\label{T:pktka}
\end{center}
\end{table}

\begin{quote}
Fragmentació a quin nivell.
Hole punching.
\end{quote}
\clearpage%Optional
\section{Arquitectura del programa}
\begin{quote}
Llenguatge C.
Threads.
\end{quote}
La arquitectura del programa com es veu en la figura \ref{F:dia-app} es separa entre l'adaptador virtual i el servidor UDP. Els paquets que les aplicacions envien a traves de l'adaptador virtual son enrutats i enviats de servidor UDP a servidor UDP on retornen a un altre adaptador virtual a la màquina de destí.
Pel que fa al adaptador virtual s'utilitza el controlador universal TUN/TAP.
\begin{figure}[htb]
\centering
\includegraphics[width=0.5\textwidth]{images/dia-app}
\caption{Diagrama de la aplicació}
\label{F:dia-app}
\end{figure}
\clearpage%Optional
\subsection{Interfície TUN}
L'aplicació fa ús del \emph{driver} genèric \okeyword{TUN}/\okeyword{TAP}. S'ha escollit aquest \emph{driver} ja que està disponible per la majoria de sistemes operatius i facilitarà la possible futura adaptació de l'aplicació.

\subsubsection{Driver TUN/TAP}
El \emph{driver} TUN/TAP es un \emph{driver} de \emph{kernel} d'una targeta de xarxa virtual, i per tant no depèn del cap targeta real física. El driver es separa en dos \emph{sub-drivers}:
\begin{itemize}
\item \textbf{Driver TAP} simula una interfície de xarxa Ethernet i treballa amb trames de capa 2 del \okeyword{model OSI}.
\item \textbf{Driver TUN} simula una interfície de xarxa punt-a-punt i treballa amb trames de capa 3 del model OSI.
\end{itemize}

En aquestes targetes els paquets enviats per el sistema operatiu al \emph{driver} són passats a l'aplicació que treballa fora del \emph{kernel} i del \emph{driver}. Els paquets que l'aplicació entrega al \emph{driver} són passats directament al sistema operatiu per a ser tractats per el \emph{stack} de protocols del \emph{kernel}.

\begin{figure}[htb]
\centering
\includegraphics[scale=0.5]{images/dia-tunsrv}
\caption{Diagrama de flux del thread TUN}
\label{F:dia-tunsrv}
\end{figure}
\clearpage%Optional
\subsection{Servidor UDP/DTLS}
\begin{figure}[htb]
\centering
\includegraphics[scale=0.5]{images/dia-udpsrv}
\caption{Diagrama de flux del thread UDP}
\label{F:dia-udpsrv}
\end{figure}
